# é¡µé¢è·¯ç”±ä¿æŠ¤å®ç°è¯´æ˜

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### 1. Cookie å·¥å…·å‡½æ•° (`src/lib/utils/cookie.ts`)

- `setCookie()` - è®¾ç½® Cookie
- `getCookie()` - è·å– Cookie
- `deleteCookie()` - åˆ é™¤ Cookie

### 2. ç™»å½•åŠŸèƒ½æ›´æ–° (`src/app/components/auth/login.tsx`)

- âœ… ç™»å½•æˆåŠŸååŒæ—¶è®¾ç½® Cookieï¼ˆç”¨äº middleware è·¯ç”±ä¿æŠ¤ï¼‰
- âœ… Token å­˜å‚¨åœ¨ localStorageï¼ˆç”¨äº API è°ƒç”¨ï¼‰
- âœ… æ”¯æŒç™»å½•åé‡å®šå‘åˆ°åŸå§‹é¡µé¢

### 3. Middleware è·¯ç”±ä¿æŠ¤ (`src/middleware.ts`)

- âœ… ä¿æŠ¤æ‰€æœ‰é¡µé¢è·¯ç”±ï¼ˆé™¤äº† `/home` å’Œ `/auth/login`ï¼‰
- âœ… ä» Cookie è¯»å– `accessToken` è¿›è¡ŒéªŒè¯
- âœ… æœªç™»å½•ç”¨æˆ·è‡ªåŠ¨é‡å®šå‘åˆ°ç™»å½•é¡µ
- âœ… æ”¯æŒä¿å­˜åŸå§‹è·¯å¾„ï¼Œç™»å½•åè·³è½¬å›æ¥

### 4. ç™»å‡ºåŠŸèƒ½æ›´æ–° (`src/app/(DashboardLayout)/layout/header/Profile.tsx`)

- âœ… æ¸…é™¤ localStorage ä¸­çš„æ‰€æœ‰æ•°æ®
- âœ… æ¸…é™¤ Cookieï¼ˆ`accessToken`ï¼‰
- âœ… ç™»å‡ºåè·³è½¬åˆ°ç™»å½•é¡µ

## ğŸ”’ è·¯ç”±ä¿æŠ¤è§„åˆ™

### å…¬å¼€è·¯ç”±ï¼ˆæ— éœ€ç™»å½•ï¼‰

- `/home` - é¦–é¡µ
- `/auth/login` - ç™»å½•é¡µ
- `/auth/register` - æ³¨å†Œé¡µï¼ˆå¦‚æœéœ€è¦ï¼‰
- `/api/*` - æ‰€æœ‰ API è·¯ç”±ï¼ˆåç«¯ä¼šéªŒè¯ï¼‰
- `/_next/*` - Next.js å†…éƒ¨è·¯ç”±
- `/favicon.ico` - å›¾æ ‡

### å—ä¿æŠ¤è·¯ç”±ï¼ˆéœ€è¦ç™»å½•ï¼‰

- `/` - ä»ªè¡¨æ¿é¦–é¡µ
- `/user-profile` - ç”¨æˆ·èµ„æ–™
- `/sample-page` - ç¤ºä¾‹é¡µé¢
- å…¶ä»–æ‰€æœ‰é¡µé¢è·¯ç”±

## ğŸ”„ å·¥ä½œæµç¨‹

### ç™»å½•æµç¨‹

1. ç”¨æˆ·åœ¨ `/auth/login` è¾“å…¥é‚®ç®±å’Œå¯†ç 
2. è°ƒç”¨åç«¯ API `/api/proxy/user/login`
3. åç«¯è¿”å› token å’Œç”¨æˆ·ä¿¡æ¯
4. **åŒæ—¶å­˜å‚¨åˆ°**ï¼š
   - `localStorage.token` - ç”¨äº API è°ƒç”¨
   - `Cookie.accessToken` - ç”¨äº middleware è·¯ç”±ä¿æŠ¤
5. è·³è½¬åˆ°ç›®æ ‡é¡µé¢æˆ–é¦–é¡µ

### è®¿é—®å—ä¿æŠ¤é¡µé¢æµç¨‹

1. ç”¨æˆ·è®¿é—®å—ä¿æŠ¤é¡µé¢ï¼ˆå¦‚ `/dashboard`ï¼‰
2. Middleware æ‹¦æˆªè¯·æ±‚
3. æ£€æŸ¥ Cookie ä¸­æ˜¯å¦æœ‰ `accessToken`
4. **å¦‚æœæœ‰ token**ï¼šå…è®¸è®¿é—®
5. **å¦‚æœæ²¡æœ‰ token**ï¼šé‡å®šå‘åˆ° `/auth/login?redirect=/dashboard`

### ç™»å‡ºæµç¨‹

1. ç”¨æˆ·ç‚¹å‡»ç™»å‡ºæŒ‰é’®
2. è°ƒç”¨åç«¯ç™»å‡º APIï¼ˆå¦‚æœæœ‰ï¼‰
3. æ¸…é™¤ localStorageï¼ˆ`userInfo`, `token`, `refresh_token`ï¼‰
4. æ¸…é™¤ Cookieï¼ˆ`accessToken`ï¼‰
5. è·³è½¬åˆ°ç™»å½•é¡µ

## ğŸ“ ä»£ç ç¤ºä¾‹

### ç™»å½•æ—¶è®¾ç½® Cookie

```typescript
// src/app/components/auth/login.tsx
const token = response.data.token;
setCookie("accessToken", token, 7); // 7 å¤©è¿‡æœŸ
```

### Middleware æ£€æŸ¥

```typescript
// src/middleware.ts
const token = request.cookies.get("accessToken")?.value;
if (!token) {
  return NextResponse.redirect(new URL("/auth/login", request.url));
}
```

### ç™»å‡ºæ—¶æ¸…é™¤ Cookie

```typescript
// src/app/(DashboardLayout)/layout/header/Profile.tsx
deleteCookie("accessToken");
```

## ğŸ”§ é…ç½®è¯´æ˜

### Cookie è®¾ç½®

- **åç§°**: `accessToken`
- **è¿‡æœŸæ—¶é—´**: 7 å¤©
- **SameSite**: `Strict`ï¼ˆCSRF ä¿æŠ¤ï¼‰
- **Path**: `/`ï¼ˆå…¨ç«™å¯ç”¨ï¼‰

### Token å­˜å‚¨ä½ç½®

1. **localStorage** - ç”¨äº API è°ƒç”¨ï¼ˆ`apiAxios` æ‹¦æˆªå™¨è‡ªåŠ¨æ·»åŠ ï¼‰
2. **Cookie** - ç”¨äº middleware è·¯ç”±ä¿æŠ¤

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **Token æ ¼å¼**: ç¡®ä¿åç«¯è¿”å›çš„ token æ˜¯å­—ç¬¦ä¸²æ ¼å¼
2. **Cookie å®‰å…¨**: ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ `httpOnly` cookieï¼ˆéœ€è¦åç«¯è®¾ç½®ï¼‰
3. **Token éªŒè¯**: Middleware åªæ£€æŸ¥ token æ˜¯å¦å­˜åœ¨ï¼Œå®Œæ•´éªŒè¯ç”±åç«¯ API å®Œæˆ
4. **è·¨åŸŸé—®é¢˜**: å¦‚æœç›´æ¥è°ƒç”¨åç«¯ APIï¼Œéœ€è¦åç«¯é…ç½® CORS

## ğŸš€ æµ‹è¯•æ­¥éª¤

1. **æµ‹è¯•æœªç™»å½•è®¿é—®**ï¼š

   - æ¸…é™¤æ‰€æœ‰ Cookie å’Œ localStorage
   - è®¿é—® `/dashboard`
   - åº”è¯¥è‡ªåŠ¨è·³è½¬åˆ° `/auth/login`

2. **æµ‹è¯•ç™»å½•**ï¼š

   - åœ¨ç™»å½•é¡µè¾“å…¥æ­£ç¡®çš„é‚®ç®±å’Œå¯†ç 
   - ç™»å½•æˆåŠŸååº”è¯¥è·³è½¬åˆ°é¦–é¡µ
   - æ£€æŸ¥ Cookie å’Œ localStorage æ˜¯å¦å·²è®¾ç½®

3. **æµ‹è¯•å—ä¿æŠ¤é¡µé¢**ï¼š

   - ç™»å½•åè®¿é—® `/user-profile`
   - åº”è¯¥å¯ä»¥æ­£å¸¸è®¿é—®

4. **æµ‹è¯•ç™»å‡º**ï¼š
   - ç‚¹å‡»ç™»å‡ºæŒ‰é’®
   - åº”è¯¥æ¸…é™¤æ‰€æœ‰æ•°æ®å¹¶è·³è½¬åˆ°ç™»å½•é¡µ
   - å†æ¬¡è®¿é—®å—ä¿æŠ¤é¡µé¢åº”è¯¥è¢«æ‹¦æˆª

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `src/middleware.ts` - è·¯ç”±ä¿æŠ¤ä¸­é—´ä»¶
- `src/lib/utils/cookie.ts` - Cookie å·¥å…·å‡½æ•°
- `src/app/components/auth/login.tsx` - ç™»å½•ç»„ä»¶
- `src/app/(DashboardLayout)/layout/header/Profile.tsx` - ç”¨æˆ·èµ„æ–™ç»„ä»¶ï¼ˆç™»å‡ºåŠŸèƒ½ï¼‰
- `src/lib/services/auth.tsx` - è®¤è¯æœåŠ¡
